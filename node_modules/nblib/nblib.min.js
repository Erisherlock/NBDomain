!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).NBLib=t()}(this,(function(){"use strict";var e,t=t||new Function("try {return this===window;}catch(e){ return false;}");const a=t();var n={API:"https://api.nbdomain.com/v1/",minerAPI:"https://merchantapi.matterpool.io",token:"",filepayKey:"",debug:!0};let i=null,r=!1,s=console.log;var o,d,c,l;let u={test:{address:{protocol:"1PuMeZswjsAM7DFHMSdmAGfQ8sGvEctiF5",admin:"1PuMeZswjsAM7DFHMSdmAGfQ8sGvEctiF5",other_admins:[],payment:"19fLpT5LpaMGKuLfUVqmNdXkVceq2rbjyn"}}};class p{static async init(e){i={...n,...e},0==i.debug&&(s=e=>{});try{u=await p.getTLDinfo(),e.enable_write&&await p._loadWriteLibs()}catch(e){throw s(e),"NBLib Init failed:"+e}}static async getDomain(e){const t=await p.readDomain(e);if(s("getting domain:"+e+"\n",t),0==t.code){return new p(e,t)}return null}static async regDomain(e){}constructor(e,t){this.info=t.obj,[this.nid,this.tld]=e.split("."),this.config=u[this.tld].address,this.lastTXID=t.obj.last_txid}setPrivateKey(e){if(!i.enable_write)throw"to be able to send transactions, Please enable_write when call init(...)";this.pKey=e;const t=l.PrivateKey.fromWIF(e);if(l.PublicKey.fromPrivateKey(t).toHex()!=this.info.owner_key)throw"Not the owner of:"+this.nid+"."+this.tld;this._nutxo_out=p._genNUTXO(this.info.owner,2)}async refresh(){const e=await p.readDomain(this.nid+"."+this.tld);if(0==e.code){const t=l.PrivateKey.fromWIF(this.pKey);return e.obj.owner!=t.toAddress().toString()?{code:-1,message:"not owner"}:e.obj.last_txid!=this.lastTXID?(this.lastTXID=e.obj.last_txid,{code:0,message:"updated"}):{code:0,message:"no change"}}return e}async updateKey(e,t=!1){let a=[t?"user":"key",JSON.stringify(e)];return await this._sendCommand(a)}async sell(e){const{price:t,buyer:a,expire:n}=e;let i={price:t,buyer:a,expire:n};e.clear_data||(i.clear_data=e.clear_data);let r=["sell",JSON.stringify(i)];return await this._sendCommand(r)}async _sendCommand(e){if(!this.pKey)throw"please setPrivateKey first";const t=await this.refresh();if(-1==t.code)return t;if(0!=t.code)return t;return await p._baseSendCommand(this.config.protocol,this.nid,this.pKey,e,this._nutxo_out,this.lastTXID)}async writeNOP(){const e=["key",JSON.stringify({__nop:"nop"})];return await p._baseSendCommand(this.config.protocol,this.nid,this.pKey,e,this._nutxo_out,null)}async updateUser(e){return await this.updateKey(e,!0)}async readKey(e){return await p.readDomain(e+"."+this.domain)}async readUser(e){return await p.readDomain(key+"@"+this.domain)}async isOwner(e){return this.info.owner==e}static _genNUTXO(e,t){return{script:p._genNUTXOOutScript(e),pos:t,value:601}}static _genNUTXOinputScript(e,t,a,n,i){let r=l;l.Script;const s=new r.PrivateKey(i),o=s.publicKey,d=r.crypto.Signature.SIGHASH_ALL|r.crypto.Signature.SIGHASH_FORKID,c=r.Script.Interpreter.SCRIPT_VERIFY_MINIMALDATA|r.Script.Interpreter.SCRIPT_ENABLE_SIGHASH_FORKID|r.Script.Interpreter.SCRIPT_ENABLE_MAGNETIC_OPCODES|r.Script.Interpreter.SCRIPT_ENABLE_MONOLITH_OPCODES,u=r.Transaction.sighash.sign(e,s,d,t,n,new r.crypto.BN(a),c).toBuffer();return(new r.Script).add(l.deps.Buffer.concat([u,l.deps.Buffer.from([255&(d||r.Signature.SIGHASH_ALL)])])).add(new l.PublicKey(o).toBuffer()).add(l.Opcode.OP_1).add(l.Opcode.OP_2).toHex()}static loadScript(e,t){var a=document.createElement("script");a.type="text/javascript",a.readyState?a.onreadystatechange=function(){"loaded"!=a.readyState&&"complete"!=a.readyState||(a.onreadystatechange=null,t&&t())}:a.onload=function(){t&&t()},a.src=e,document.getElementsByTagName("head")[0].appendChild(a)}static async _loadWriteLibs(){return new Promise(e=>{if(r)e(!0);else if(a){const t=this;this.loadScript("https://unpkg.com/filepay@latest/dist/filepay.min.js",()=>{o=window.filepay,l=o.bsv,t.loadScript("https://unpkg.com/bitidentity@1.0.29/bitIdentity.min.js",()=>{(d=window.BitID).config({debug:i.debug}),t.loadScript("https://unpkg.com/minercraft",()=>{c=new window.Minercraft({url:i.minerAPI,headers:{"Content-Type":"application/json"}}),e(!0)})})}),e(!1)}else{if(!(o=require("filepay")))throw"please npm i filepay";if(l=o.bsv,!(d=require("bitIdentity")))throw"please npm i bitidentity";const t=require("minercraft");if(!t)throw"please npm i minercraft";c=new t({url:i.minerAPI,headers:{"Content-Type":"application/json"}}),d.config({debug:i.debug}),r=!0,e(!0)}})}static _genNUTXOOutScript(e){"string"==typeof e&&(e=new l.Address(e));const t=l.Script,a=l.Opcode;var n=new t;return n.add(a.OP_2DROP).add(a.OP_DUP).add(a.OP_HASH160).add(e.hashBuffer).add(a.OP_EQUALVERIFY).add(a.OP_CHECKSIG),n._network=e.network,n}static async _baseSendCommand(e,t,a,n,r,o,l=null,u=!0){if(!i.enable_write)throw"to be able to send transactions, Please enable_write when call init(...)";return new Promise(async m=>{const y={api_key:i.filepayKey,pay:{key:a,feeb:.5,to:[{data:[e,t],value:0},{protocol:"bitIdentity",value:{privateKey:a}}]}};y.pay.to[0].data=y.pay.to[0].data.concat(n),r&&y.pay.to.push({script:r.script,value:r.value}),l&&(y.pay.to=y.pay.to.concat(l)),o&&(y.pay.inputs=[{txid:o,value:r.value,script:r.script,outputIndex:r.pos,required:!0,unlockingScript:function(e,t,a,n,i){return p._genNUTXOinputScript(e,t,a,n,i)}}]),d.filepayKey=i.filepayKey;const f=await d.gentx(y);if(f){if(!u)return void m({code:0,rawtx:f});let e=await c.tx.push(f);""==e.txid?(-1!=e.resultDescription.indexOf("258")&&(s("nUTXO conflict found"),m({code:101,message:"nUTXO conflict found"})),e.code=1):e.code=0,m(e)}else m({code:100,message:"bitID.gentx error"})})}static isValidAdmin(e,t){const a=u[e].address;return t==a.admin||a.other_admins.includs(t)}static async admin_regDomain(e,t,a,n,r){if(!i.enable_write)throw"to be able to send transactions, Please enable_write when call init(...)";const s=e.split("."),o=u[s[1]].address,d=l.PrivateKey.fromWIF(t).toAddress().toString();if(o.admin!=d)return{code:1,message:"Not allowed"};const c=await p.readDomain(e);if(0==c.code)return{code:2,message:"already registered"};if(null==c.price)return{code:3,message:"Not allowed to register"};const m=["register",a];n&&m.push(JSON.stringify({pay_txid:n})),r&&m.push(r);const y=l.PublicKey.fromHex(a).toAddress().toString(),f=p._genNUTXO(y,2);return await p._baseSendCommand(o.protocol,s[0],t,m,f,null)}static async admin_buyDomain(e,t,a,n,r){if(!i.enable_write)throw"to be able to send transactions, Please enable_write when call init(...)";const s=e.split("."),o=u[s[1]].address,d=l.PrivateKey.fromWIF(t).toAddress().toString();if(o.admin!=d)return{code:1,message:"Not allowed"};const c=["buy",a,JSON.stringify({sell_txid:n,pay_txid:r})],m=l.PublicKey.fromHex(a).toAddress().toString(),y=p._genNUTXO(m,2);return await p._baseSendCommand(o.protocol,s[0],t,c,y,null)}static async admin_writeNOP(e,t,a){if(!i.enable_write)throw"to be able to send transactions, Please enable_write when call init(...)";const n=e.split("."),r=u[n[1]].address,s=l.PrivateKey.fromWIF(t).toAddress().toString();if(r.admin!=s)return{code:1,message:"Not allowed"};const o=l.PublicKey.fromHex(a).toAddress().toString(),d=p._genNUTXO(o,2);return await p._baseSendCommand(r.protocol,n[0],t,["nop"],d,null)}static async buyDomain(e,t){const a=await p._buildBuyTX(e,t);if(0==a.code){const e=await p._InvokeRawCMD(a.rawtx);return s(e),e}return a}static async registerDomain(e,t){const a=await p._buildRegTX(e,t);if(0==a.code){const e=await p._InvokeRawCMD(a.rawtx);return s(e),e}return a}static async _InvokeRawCMD(t){if(!i.enable_write)throw"to be able to send transactions, Please enable_write when call init(...)";const a=i.API+"raw_cmd",n={method:"POST",headers:{"content-type":"application/json;charset=UTF-8",Authorization:"Bearer "+i.token},mode:"cors"};try{let i=(await e.post(a,JSON.stringify({rawtx:t}),n)).data;return s("raw cmd result:",i),{code:0,txid:i.tx,message:"success"}}catch(e){return{code:1,message:e.message}}}static async _buildRegTX(e,t,a=null){if(!i.enable_write)throw"to be able to send transactions, Please enable_write when call init(...)";const n=e.split("."),r=u[n[1]].address;try{const i=await p.readDomain(e);if(0==i.code)return{code:1,message:"Domain is registered"};if(!i.price)return{code:2,message:"Domain is reserved"};const s=l.PrivateKey.fromWIF(t),o=["register",l.PublicKey.fromPrivateKey(s).toHex()];a&&(o=o.concat(a));const d=[{address:r.payment,value:i.price}];return await p._baseSendCommand(r.payment,n[0],t,o,null,null,d,!1)}catch(e){return s(e),{code:100,message:e.message}}}static async _buildBuyTX(e,t){if(!i.enable_write)throw"to be able to send transactions, Please enable_write when call init(...)";const a=e.split("."),n=u[a[1]].address;try{const i=await p.readDomain(e);if(0!=i.code)return{code:1,message:"Domain is not registered"};if(null==i.obj.sell_info)return{code:2,message:"Domain is not on sale"};const{buyer:r,price:s,expire:o,sell_txid:d}=i.obj.sell_info,c=new Date(o);if(Date.now()>c)return{code:3,message:"Sell Expired"};if("any"!=r){if(l.PrivateKey.fromWIF(t).toAddress().toString()!=r)return{code:4,message:"Incorrect Buyer"}}const u=.9*s,m=.1*s,y=["buy",JSON.stringify({sell_txid:d})],f=[{address:i.obj.owner,value:u},{address:n.payment,value:m}];return await p._baseSendCommand(n.payment,a[0],t,y,null,null,f,!1)}catch(e){return s(e),{code:100,message:e.message}}}static async _invokeAPI(t){const a=i.API+t,n={method:"GET",headers:{"content-type":"application/json;charset=UTF-8",Authorization:"Bearer "+i.token},mode:"cors",cache:"default"};try{const t=await e.get(a,n);if(t)return t.data}catch(e){s(e)}return null}static async getTLDinfo(){return await p._invokeAPI("tld")}static async readDomain(e,t=!1){const a="?nid="+e+"&full="+(t?"true":"false");return await p._invokeAPI(a)}static async domainFromAddress(e){return await p._invokeAPI("find_domain?address="+e)}}return 0==a?e=require("axios"):p.loadScript("https://unpkg.com/axios/dist/axios.min.js",()=>{e=window.axios}),0==a&&(module.exports=p),p}));
